{{ $p := .Section }}

{{ if eq $p "books" }}
{{ $p = "books/tags"}}
{{ end }}

{{ $is_authors_page := eq $p "authors" }}

{{ $page_num := 0 }}
{{ $taxonomy := index .Site.Taxonomies $p }}
{{ $taxonomy = $taxonomy.ByCount }}
{{ range $t := $taxonomy }}
  {{ if gt $t.Count 0 }}
  {{ $pretty_tag := index $.Site.Data.tag_mapping $t.Term | default $t.Term }}
  {{ if or $is_authors_page (eq $p "books/tags") }}
  {{ if ne $t.Page.Title "Fiction" }}
  <div class="row align-items-center">
    <a href="{{ $t.Page.RelPermalink }}">
      <span class="h1">{{ $t.Page.Title }}</span>
    </a>
  </div>
  {{ if $t.Page.Summary }}
  <div class="row align-items-center">
    <p class="text-center">{{ $t.Page.Summary }}</p>
  </div>
  {{ end }}
  <div class="row align-items-center">
    {{ $i := 0 }}
    {{ $books := ($t.Pages.ByDate.ByParam "star_rating").Reverse }}

    {{ $all_books := slice }}
    {{ range $books }}
      {{ $main_book := . }}
      {{ if not (in $all_books $main_book) }}
        {{ $related_books := (.Site.Pages.Related $main_book | append $main_book).ByDate }}
        {{ range $related_books }}
          {{ $related_book := . }}
          {{ if not (in $all_books $related_book) }}
            {{ $all_books = $all_books | append $related_book }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}

    {{ range $all_books }}
    {{ $book_tags := index .Params "books/tags"}}
     {{ if or $is_authors_page (not (and (and (ne $t.Page.Title "Trash") (ne $t.Page.Title "DNF") ) (or (in $book_tags "trash") (in $book_tags "dnf")))) }}
     {{ $i = add  $i 1 }}
     {{ $page_num = add $page_num 1 }}
    <div class="col">
      <a href="{{ .Permalink }}">
        <div class="row text-center">
          <div class="col">
          {{ partial "try_star_rating" . }}
          </div>
        </div>
        <div class="row">
          <div class="col text-center">
            {{ $lazy_loading := "lazy"}}
            {{ if lt $page_num 7 }}
              {{ $lazy_loading = "eager"}}
            {{ end }}
            {{ $thumbnail := .Resources.GetMatch "thumbnail.*" }}
            {{ if $thumbnail }}
              {{ partial "img" (dict
              "widths" (slice 100 150)
              "aspect_ratio" "2:3"
              "fit" "contain"
              "src" "thumbnail.*"
              "ctx" .
              "class" "img-fluid rounded mx-auto"
              "alt" "Thumbnail"
              "loading" $lazy_loading
              ) }}
            {{ end }}
          </div>
        </div>
      </a>
    </div>
    {{ end }}
    {{ if eq (mod $i 6) 0 }}
    <div class="w-100"></div>
    {{ end }}
    {{ end }}
  </div>
  {{ end }}
  {{ else }}
  <a href="{{ $t.Page.RelPermalink }}">
    <li> {{ humanize $pretty_tag }} </li>
  </a>
  <ul>
    {{ range $t.Pages }}
    <li hugo-nav="{{ .RelPermalink  }}">
      <a href="{{ .Permalink  }}"> {{ .LinkTitle }} </a>
    </li>
    {{ end }}
  </ul>
  {{ end }}
  {{ end }}
{{ end }}

